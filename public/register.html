<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>Login</title>
    <link rel="stylesheet" href="./main.css">
    <link rel="apple-touch-icon" sizes="180x180" href="/static/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/static/favicon-32x32.png">
    <link rel="manifest" href="/static/manifest.json">
    <link rel="icon" type="image/png" sizes="16x16" href="/static/favicon-16x16.png">
    <link rel="mask-icon" href="/static/safari-pinned-tab.svg" color="#42b983">
    <meta name="msapplication-TileColor" content="#42b983">
    <meta name="theme-color" content="#ffffff">
  </head>
  <body class="theme-light">
    <noscript>
      You need to enable JavaScript to run this app.
    </noscript>
    <div>
      <div class="container">
          <div class="register-box margin-center">
              <div class="register_welcome">Welcome!</div>
              <div class="register-container">
                <form class="register" id="register" method="POST" action="/register">
                  <div class="form-group">
                    <label for="register-username">Username: </label>
                    <input autocomplete="username" class="text-input input-big" id="register-username" type="text">
                  </div>
                  <div class="form-group">
                    <label for="register-email">Email: </label>
                    <input class="text-input input-big" id="register-email" type="email">
                  </div>
                  <div class="form-group">
                    <div class="form-group-2">
                      <label for="register-firstname">First name: </label>
                      <input class="text-input input-big" id="register-firstname" type="text">
                    </div>
                    <div class="form-group-2">
                      <label for="register-lastname">Last name: </label>
                      <input class="text-input input-big" id="register-lastname" type="text">
                    </div>
                  </div>
                  <div class="form-group">
                    <label for="register-password">Password: </label>
                    <input autocomplete="new-password" class="text-input input-big" id="register-password" type="password">
                  </div>
                  <div class="form-group">
                    <label for="register-repeat-password">Repeat password: </label>
                    <input autocomplete="new-password" class="text-input input-big" id="register-repeat-password" type="password">
                  </div>
                  <input type="submit" style="display: none;">
                  <button type="submit" class="btn btn-big btn-standard center">Register</button>
                  <p class="subtext">Already have an account? <a class="register-sublink" style="cursor:pointer;" onclick="window.location.replace('/login' + window.location.search)">Log in!</a></p>
                </form>
              </div>
            </div>
      </div>
    </div>
    <script>
      function getUrlParameter(name) {
        name = name.replace(/[\[]/, '\\[').replace(/[\]]/, '\\]');
        var regex = new RegExp('[\\?&]' + name + '=([^&#]*)');
        var results = regex.exec(location.search);
        return results === null ? '' : decodeURIComponent(results[1].replace(/\+/g, ' '));
      };

      function post(url, body, headers) {
        return window.fetch(url, {
          method: 'POST',
          body: JSON.stringify(body),
          headers: Object.assign({
            'Accept': 'application/json',
            'Content-Type': 'application/json'
          }, headers)
        })
      }

      document.querySelector('form.register#register').addEventListener('submit', function (evt) {
        evt.preventDefault()

        const username = document.querySelector('form.register#register #register-username').value
        const email = document.querySelector('form.register#register #register-email').value
        const password = document.querySelector('form.register#register #register-password').value
        const password_repeat = document.querySelector('form.register#register #register-repeat-password').value
        const first_name = document.querySelector('form.register#register #register-firstname').value
        const last_name = document.querySelector('form.register#register #register-lastname').value

        console.log({ username, email, password, password_repeat, first_name, last_name })

        if(password === password_repeat) {
          post('/add', { username, email, password, first_name, last_name })
            .then(function (res) { return res.json() })
            .then(function (json) { return json.message === 'account creation successful' 
              ? Promise.resolve(json)
              : Promise.reject(json)
            })
            .then(function(json) {
              return window.location.replace(getUrlParameter('from') + '?href=' + encodeURIComponent(getUrlParameter('href')) + '&jwt=' + json.token )
            })
            .catch(console.log)
        }
        
      })
    </script>
  </body>
</html>